#include <algorithm>
#include <fstream>
#include <strstream>

#include <kuai/tools/strtool.h>
#include <kuai/tools/common.h>
#include <kuai/mols/Element.h>

namespace kuai {
	
	static const Element ELEMENT_DATA [] = {
		/*          avg  norm                        El    No  -------- Valence(s) of an ion or neutral atom -------------*/
		/*           mw  mass    exact mw     type   neg   H   -2          -1          0           +1         +2          */
		{  0, "0",    0,   0,   0.000000000,     0 ,  .0,  0, {{0,},       {0,},       {0,},       {0,},       {0,}       }},
		{  1, "H",    1,   1,   1.007825035,     0 , 2.1,  0, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{  2, "He",   4,   4,   4.002600000,     0 ,  .0,  0, {{0,},       {0,},       {0,},       {0,},       {0,}       }},
		{  3, "Li",   7,   7,   7.016000000, METAL , 1.0,  0, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{  4, "Be",   9,   9,   9.012180000, METAL , 1.5,  0, {{0,},       {0,},       {2,},       {1,},       {0,}       }},
		{  5, "B",   11,  11,  11.009300000,     0 , 2.0,  0, {{3,},       {4,},       {3,},       {2,},       {1,}       }},
		{  6, "C",   12,  12,  12.000000000,     0 , 2.5,  0, {{2,},       {3,},       {4,},       {3,},       {2,}       }},
		{  7, "N",   14,  14,  14.003074000,     0 , 3.0,  0, {{1,},       {2,},       {3,5},      {4,},       {3,}       }},
		{  8, "O",   16,  16,  15.994914630,     0 , 3.5,  0, {{0,},       {1,},       {2,},       {3,5,},     {4,}       }},
		{  9, "F",   19,  19,  18.998403220,     0 , 4.0,  0, {{0,},       {0,},       {1,},       {2,},       {3,5}      }},
		{ 10, "Ne",  20,  20,  19.992440000,     0 ,  .0,  0, {{0,},       {0,},       {0,},       {0,},       {0,}       }},
		{ 11, "Na",  23,  23,  22.989770000, METAL ,  .9,  0, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{ 12, "Mg",  24,  24,  23.985000000, METAL , 1.2,  0, {{0,},       {0,},       {2,},       {1,},       {0,}       }},
		{ 13, "Al",  27,  27,  26.981540000, METAL , 1.5,  0, {{3,5,},     {4,},       {3,},       {2,},       {1,}       }},
		{ 14, "Si",  28,  28,  27.976927100,     0 , 1.8,  0, {{2,},       {3,5},      {4,},       {3,},       {2,}       }},
		{ 15, "P",   31,  31,  30.973762000,     0 , 2.1,  0, {{1,3,5,7,}, {2,4,6,},   {3,5,},     {4,},       {3,}       }},
		{ 16, "S",   32,  32,  31.972070700,     0 , 2.5,  0, {{0,},       {1,3,5,7,}, {2,4,6},    {3,5,},     {4,}       }},
		{ 17, "Cl",  35,  35,  34.968852730,     0 , 3.0,  0, {{0,},       {0,},       {1,3,5,7},  {2,4,6},    {3,5,}     }},
		{ 18, "Ar",  40,  40,  39.962400000,     0 ,  .0,  0, {{0,},       {0,},       {0,},       {0,},       {0,}       }},
		{ 19, "K",   39,  39,  38.963700000, METAL ,  .8,  0, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{ 20, "Ca",  40,  40,  39.962600000, METAL , 1.0,  0, {{0,},       {0,},       {2,},       {1,},       {0,}       }},
		{ 21, "Sc",  45,  45,  44.955910000, METAL , 1.3,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 22, "Ti",  48,  48,  47.947950000, METAL , 1.5,  1, {{0,},       {0,},       {3,4},      {0,},       {0,}       }},
		{ 23, "V",   51,  51,  50.943960000, METAL , 1.6,  1, {{0,},       {0,},       {2,3,4,5,}, {0,},       {0,}       }},
		{ 24, "Cr",  52,  52,  51.940500000, METAL , 1.6,  1, {{0,},       {0,},       {2,3,6,},   {0,},       {0,}       }},
		{ 25, "Mn",  55,  55,  54.938050000, METAL2, 1.5,  1, {{0,},       {0,},       {2,3,4,6,}, {0,},       {0,}       }},
		{ 26, "Fe",  56,  56,  55.934900000, METAL2, 1.8,  1, {{0,},       {0,},       {2,3,4,6,}, {0,},       {0,}       }},
		{ 27, "Co",  59,  59,  58.933200000, METAL2, 1.8,  1, {{0,},       {0,},       {2,3,},     {0,},       {0,}       }},
		{ 28, "Ni",  59,  58,  57.935300000, METAL2, 1.8,  1, {{0,},       {0,},       {2,3,},     {0,},       {0,}       }},
		{ 29, "Cu",  64,  63,  62.929600000, METAL , 1.9,  1, {{0,},       {0,},       {1,2,},     {0,},       {0,}       }},
		{ 30, "Zn",  65,  64,  63.929147000, METAL , 1.6,  1, {{0,},       {0,},       {2,},       {0,},       {0,}       }},
		{ 31, "Ga",  70,  69,  68.925600000, METAL , 1.8,  0, {{3,5,},     {4,},       {3,},       {0,},       {1,}       }},
		{ 32, "Ge",  73,  74,  73.921177400,     0 , 1.8,  0, {{2,4,6,},   {3,5,},     {4,},       {3,},       {0,}       }},
		{ 33, "As",  75,  75,  74.921594200,     0 , 2.0,  0, {{1,3,5,7,}, {2,4,6,},   {3,5,},     {4,},       {3,}       }},
		{ 34, "Se",  79,  80,  79.916519600,     0 , 2.4,  0, {{0,},       {1,3,5,7,}, {2,4,6,},   {3,5,},     {4,}       }},
		{ 35, "Br",  80,  79,  78.918336100,     0 , 2.8,  0, {{0,},       {0,},       {1,3,5,7,}, {2,4,6,},   {3,5,}     }},
		{ 36, "Kr",  84,  84,  83.911500000,     0 ,  .0,  0, {{0,},       {0,},       {0,},       {0,},       {0,}       }},
		{ 37, "Rb",  85,  85,  84.911800000, METAL ,  .8,  0, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{ 38, "Sr",  88,  88,  87.905600000, METAL , 1.0,  0, {{0,},       {0,},       {2,},       {1,},       {0,}       }},
		{ 39, "Y",   89,  89,  88.905860000, METAL , 1.2,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 40, "Zr",  91,  90,  89.904700000, METAL , 1.4,  1, {{0,},       {0,},       {4,},       {0,},       {0,}       }},
		{ 41, "Nb",  93,  93,  92.906400000, METAL , 1.6,  1, {{0,},       {0,},       {3,5,},     {0,},       {0,}       }},
		{ 42, "Mo",  96,  98,  97.905400000, METAL , 1.8,  1, {{0,},       {0,},       {3,4,5,6,}, {0,},       {0,}       }},
		{ 43, "Tc",  98,  98,  97.907200000, METAL , 1.9,  1, {{0,},       {0,},       {7,},       {0,},       {0,}       }},
		{ 44, "Ru", 101, 102, 101.904300000, METAL , 2.2,  1, {{0,},       {0,},       {2,3,4,6,}, {0,},       {0,}       }},
		{ 45, "Rh", 103, 103, 102.905500000, METAL , 2.2,  1, {{0,},       {0,},       {2,3,4,},   {0,},       {0,}       }},
		{ 46, "Pd", 106, 106, 105.903500000, METAL , 2.2,  1, {{0,},       {0,},       {2,4,},     {0,},       {0,}       }},
		{ 47, "Ag", 108, 107, 106.905100000, METAL , 1.9,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{ 48, "Cd", 112, 114, 113.903400000, METAL , 1.7,  1, {{0,},       {0,},       {2,},       {0,},       {0,}       }},
		{ 49, "In", 115, 115, 114.903900000, METAL , 1.7,  0, {{3,5,},     {2,4,},     {3,},       {0,},       {1,}       }},
		{ 50, "Sn", 119, 120, 119.902200000, METAL2, 1.8,  0, {{2,4,6,},   {3,5},      {2,4,},     {3,},       {0,}       }},
		{ 51, "Sb", 122, 121, 120.903800000, METAL,  1.9,  0, {{1,3,5,7,}, {2,4,6,},   {3,5,},     {2,4,},     {3,}       }},
		{ 52, "Te", 128, 130, 129.906200000,     0 , 2.1,  0, {{0,},       {1,3,5,7,}, {2,4,6,},   {3,5,},     {2,4,}     }},
		{ 53, "I",  127, 127, 126.904500000,     0 , 2.5,  0, {{0,},       {0,},       {1,3,5,7,}, {2,4,6},    {3,5,}     }},
		{ 54, "Xe", 131, 132, 131.904100000,     0 ,  .0,  0, {{0,},       {0,},       {0,},       {0,},       {0,}       }},
		{ 55, "Cs", 133, 133, 132.905430000, METAL ,  .7,  0, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{ 56, "Ba", 137, 138, 137.905200000, METAL ,  .9,  0, {{0,},       {0,},       {2,},       {1,},       {0,}       }},
		{ 57, "La", 139, 139, 138.906360000, METAL , 1.1,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 58, "Ce", 140, 140, 139.905400000, METAL2,  .0,  1, {{0,},       {0,},       {3,4,},     {0,},       {0,}       }},
		{ 59, "Pr", 141, 141, 140.907660000, METAL2,  .0,  1, {{0,},       {0,},       {3,4,},     {0,},       {0,}       }},
		{ 60, "Nd", 144, 142, 141.907719000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 61, "Pm", 145, 145, 144.912800000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 62, "Sm", 150, 152, 151.919700000, METAL2,  .0,  1, {{0,},       {0,},       {2,3,},     {0,},       {0,}       }},
		{ 63, "Eu", 152, 153, 152.921200000, METAL2,  .0,  1, {{0,},       {0,},       {2,3,},     {0,},       {0,}       }},
		{ 64, "Gd", 157, 158, 157.924099000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 65, "Tb", 159, 159, 158.925350000, METAL2,  .0,  1, {{0,},       {0,},       {3,4,},     {0,},       {0,}       }},
		{ 66, "Dy", 163, 164, 163.929200000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }}, /*  mw rounding uncertain */
		{ 67, "Ho", 165, 165, 164.930300000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 68, "Er", 167, 166, 165.930300000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 69, "Tm", 169, 169, 168.934230000, METAL2,  .0,  1, {{0,},       {0,},       {2,3,},     {0,},       {0,}       }},
		{ 70, "Yb", 173, 174, 173.938900000, METAL2,  .0,  1, {{0,},       {0,},       {2,3,},     {0,},       {0,}       }},
		{ 71, "Lu", 175, 175, 174.940800000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 72, "Hf", 178, 180, 179.946600000, METAL , 1.3,  1, {{0,},       {0,},       {4,},       {0,},       {0,}       }},
		{ 73, "Ta", 181, 181, 180.948010000, METAL , 1.5,  1, {{0,},       {0,},       {5,},       {0,},       {0,}       }},
		{ 74, "W",  184, 184, 183.951000000, METAL2, 1.7,  1, {{0,},       {0,},       {3,4,5,6,}, {0,},       {0,}       }},
		{ 75, "Re", 186, 187, 186.955800000, METAL2, 1.9,  1, {{0,},       {0,},       {2,4,6,7,}, {0,},       {0,}       }},
		{ 76, "Os", 190, 192, 191.961500000, METAL2, 2.2,  1, {{0,},       {0,},       {2,3,4,6,}, {0,},       {0,}       }},
		{ 77, "Ir", 192, 193, 192.962900000, METAL2, 2.2,  1, {{0,},       {0,},       {2,3,4,6,}, {0,},       {0,}       }},
		{ 78, "Pt", 195, 195, 194.964800000, METAL2, 2.2,  1, {{0,},       {0,},       {2,4,},     {0,},       {0,}       }},
		{ 79, "Au", 197, 197, 196.966560000, METAL , 2.4,  1, {{0,},       {0,},       {1,3,},     {0,},       {0,}       }},
		{ 80, "Hg", 201, 202, 201.970617000, METAL2, 1.9,  1, {{0,},       {0,},       {1,2,},     {0,},       {0,}       }},
		{ 81, "Tl", 204, 205, 204.974400000, METAL2, 1.8,  0, {{3,5,},     {2,4,},     {1,3,},     {0,},       {0,}       }},
		{ 82, "Pb", 207, 208, 207.976627000, METAL2, 1.8,  0, {{2,4,6,},   {3,5},      {2,4,},     {3,},       {0,}       }},
		{ 83, "Bi", 209, 209, 208.980390000, METAL , 1.9,  0, {{1,3,5,7,}, {2,4,6,},   {3,5,},     {2,4,},     {3,}       }},
		{ 84, "Po", 209, 209, 208.982400000, METAL2, 2.0,  0, {{0,},       {1,3,5,7,}, {2,4,6,},   {3,5,},     {2,4,}     }},
		{ 85, "At", 210, 210, 209.987100000,     0 , 2.2,  0, {{0,},       {0,},       {1,3,5,7,}, {2,4,6},    {3,5,}     }},
		{ 86, "Rn", 222, 222, 222.017500000,     0 ,  .0,  0, {{0,},       {0,},       {0,},       {0,},       {0,}       }},
		{ 87, "Fr", 223, 223, 223.019700000, METAL ,  .0,  0, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{ 88, "Ra", 226, 226, 226.025410000, METAL ,  .0,  0, {{0,},       {0,},       {2,},       {1,},       {0,}       }},
		{ 89, "Ac", 227, 227, 227.027750000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 90, "Th", 232, 232, 232.038050000, METAL2,  .0,  1, {{0,},       {0,},       {3,4,},     {0,},       {0,}       }},
		{ 91, "Pa", 231, 231, 231.035880000, METAL2,  .0,  1, {{0,},       {0,},       {3,4,5,},   {0,},       {0,}       }},
		{ 92, "U",  238, 238, 238.050790000, METAL2,  .0,  1, {{0,},       {0,},       {3,4,5,6,}, {0,},       {0,}       }},
		{ 93, "Np", 237, 237, 237.048170000, METAL2,  .0,  1, {{0,},       {0,},       {3,4,5,6,}, {0,},       {0,}       }},
		{ 94, "Pu", 244, 244, 244.064200000, METAL2,  .0,  1, {{0,},       {0,},       {3,4,5,6,}, {0,},       {0,}       }},
		{ 95, "Am", 243, 243, 243.061370000, METAL2,  .0,  1, {{0,},       {0,},       {3,4,5,6,}, {0,},       {0,}       }},
		{ 96, "Cm", 247, 247, 247.070300000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 97, "Bk", 247, 247, 247.070300000, METAL ,  .0,  1, {{0,},       {0,},       {3,4,},     {0,},       {0,}       }},
		{ 98, "Cf", 251, 251, 251.079600000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{ 99, "Es", 252, 252, 252.082800000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{100, "Fm", 257, 257, 257.095100000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{101, "Md", 258, 258, 258.098600000, METAL ,  .0,  1, {{0,},       {0,},       {3,},       {0,},       {0,}       }},
		{102, "No", 259, 259, 259.100900000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{103, "Lr", 260, 260, 260.105400000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{104, "Rf", 261, 261, 261.108700000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{105, "Db", 268, 268, 268.125000000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{106, "Sg", 271, 271, 271.133000000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{107, "Bh", 267, 267, 267.127700000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{108, "Hs", 277, 277, 277.150000000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{109, "Mt", 276, 276, 276.151000000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{110, "Ds", 281, 281, 281.162000000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{111, "Rg", 280, 280, 280.164000000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{112, "Cn", 285, 285, 285.174000000, METAL ,  .0,  1, {{0,},       {0,},       {1,},       {0,},       {0,}       }},
		{  0, "",     0,   0,   0.000000000,     0 ,  .0,  0, {{0,},       {0,},       {0,},       {0,},       {0,}       }}
	};

	static const Element ELEMENT_D = {1,  "D",    2,   2,   2.014101778,     0 , 21,  0, {{0,},       {0,},       {1,},       {0,},       {0,}       }};
	static const Element ELEMENT_T = {1,  "T",    3,   3,   3.016049268,     0 , 21,  0, {{0,},       {0,},       {1,},       {0,},       {0,}       }};

	const Element* Element::get(Index i) {
		if (i < ARRAY_LENGTH(ELEMENT_DATA)) {
			return ELEMENT_DATA+i;
		}
		else {
			return NULL;
		}
	}
	
	const Element* Element::get(const Char symbol[]) {
		return Element::get(String(symbol));
	}
	const Element* Element::get(const String& symbol) {
		static HashMap<String, const Element*> elements;
		if (elements.empty()) {
			for (Index i = 0; i < ARRAY_LENGTH(ELEMENT_DATA); ++i) {
				elements[ELEMENT_DATA[i].symbol] = ELEMENT_DATA+i;
			}
			elements[ELEMENT_D.symbol] = &ELEMENT_D;
			elements[ELEMENT_T.symbol] = &ELEMENT_T;
		}
		HashMap<String, const Element*>::const_iterator it = elements.find(symbol);
		if (it != elements.end()) {
			return it->second;
		}
		else {
			return NULL;
		}
	}

}
